{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 71, "column": 0}, "map": {"version":3,"sources":["file:///Users/mg/event-horizon/services/firehose.ts"],"sourcesContent":["export interface CommitEvent {\r\n  seq: number;\r\n  time: string;\r\n  repo: string;\r\n  ops: {\r\n    action: string;\r\n    path: string;\r\n    cid?: string;\r\n    record?: any;\r\n  }[];\r\n}\r\n\r\nclass FirehoseService {\r\n  private ws: WebSocket | null = null;\r\n  private latestEvent: CommitEvent | null = null;\r\n  private eventCallback: ((event: CommitEvent) => void) | null = null;\r\n  private reconnectAttempts = 0;\r\n  private maxReconnectAttempts = 5;\r\n  private reconnectDelay = 1000;\r\n\r\n  constructor() {\r\n    this.connect();\r\n  }\r\n\r\n  private connect() {\r\n    try {\r\n      console.log(\"Connecting to Bluesky Firehose...\");\r\n      this.ws = new WebSocket('wss://bsky.network');\r\n\r\n      this.ws.onopen = () => {\r\n        console.log(\"Connected to Bluesky Firehose\");\r\n        this.reconnectAttempts = 0;\r\n      };\r\n\r\n      this.ws.onmessage = (event) => {\r\n        try {\r\n          const data = JSON.parse(event.data);\r\n          if (data.op === 'commit') {\r\n            const commit: CommitEvent = {\r\n              seq: data.seq,\r\n              time: data.time,\r\n              repo: data.repo,\r\n              ops: data.ops.map((op: any) => ({\r\n                action: op.action,\r\n                path: op.path,\r\n                cid: op.cid,\r\n                record: op.record\r\n              }))\r\n            };\r\n            \r\n            console.log(\"Received commit:\", commit);\r\n            this.latestEvent = commit;\r\n            \r\n            if (this.eventCallback) {\r\n              this.eventCallback(commit);\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.error(\"Error processing message:\", error);\r\n        }\r\n      };\r\n\r\n      this.ws.onclose = () => {\r\n        console.log(\"Disconnected from Bluesky Firehose\");\r\n        this.attemptReconnect();\r\n      };\r\n\r\n      this.ws.onerror = (error) => {\r\n        console.error(\"WebSocket error:\", error);\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error(\"Error creating WebSocket:\", error);\r\n      this.attemptReconnect();\r\n    }\r\n  }\r\n\r\n  private attemptReconnect() {\r\n    if (this.reconnectAttempts < this.maxReconnectAttempts) {\r\n      this.reconnectAttempts++;\r\n      console.log(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);\r\n      setTimeout(() => this.connect(), this.reconnectDelay * this.reconnectAttempts);\r\n    } else {\r\n      console.error(\"Max reconnection attempts reached\");\r\n    }\r\n  }\r\n\r\n  public onEvent(callback: (event: CommitEvent) => void) {\r\n    this.eventCallback = callback;\r\n    if (this.latestEvent) {\r\n      callback(this.latestEvent);\r\n    }\r\n  }\r\n\r\n  public getLatestEvent(): CommitEvent | null {\r\n    return this.latestEvent;\r\n  }\r\n\r\n  public disconnect() {\r\n    if (this.ws) {\r\n      this.ws.close();\r\n      this.ws = null;\r\n    }\r\n  }\r\n}\r\n\r\nexport const firehoseService = new FirehoseService();\r\n"],"names":[],"mappings":";;;AAYA,MAAM;IACI,KAAuB,KAAK;IAC5B,cAAkC,KAAK;IACvC,gBAAuD,KAAK;IAC5D,oBAAoB,EAAE;IACtB,uBAAuB,EAAE;IACzB,iBAAiB,KAAK;IAE9B,aAAc;QACZ,IAAI,CAAC,OAAO;IACd;IAEQ,UAAU;QAChB,IAAI;YACF,QAAQ,GAAG,CAAC;YACZ,IAAI,CAAC,EAAE,GAAG,IAAI,UAAU;YAExB,IAAI,CAAC,EAAE,CAAC,MAAM,GAAG;gBACf,QAAQ,GAAG,CAAC;gBACZ,IAAI,CAAC,iBAAiB,GAAG;YAC3B;YAEA,IAAI,CAAC,EAAE,CAAC,SAAS,GAAG,CAAC;gBACnB,IAAI;oBACF,MAAM,OAAO,KAAK,KAAK,CAAC,MAAM,IAAI;oBAClC,IAAI,KAAK,EAAE,KAAK,UAAU;wBACxB,MAAM,SAAsB;4BAC1B,KAAK,KAAK,GAAG;4BACb,MAAM,KAAK,IAAI;4BACf,MAAM,KAAK,IAAI;4BACf,KAAK,KAAK,GAAG,CAAC,GAAG,CAAC,CAAC,KAAY,CAAC;oCAC9B,QAAQ,GAAG,MAAM;oCACjB,MAAM,GAAG,IAAI;oCACb,KAAK,GAAG,GAAG;oCACX,QAAQ,GAAG,MAAM;gCACnB,CAAC;wBACH;wBAEA,QAAQ,GAAG,CAAC,oBAAoB;wBAChC,IAAI,CAAC,WAAW,GAAG;wBAEnB,IAAI,IAAI,CAAC,aAAa,EAAE;4BACtB,IAAI,CAAC,aAAa,CAAC;wBACrB;oBACF;gBACF,EAAE,OAAO,OAAO;oBACd,QAAQ,KAAK,CAAC,6BAA6B;gBAC7C;YACF;YAEA,IAAI,CAAC,EAAE,CAAC,OAAO,GAAG;gBAChB,QAAQ,GAAG,CAAC;gBACZ,IAAI,CAAC,gBAAgB;YACvB;YAEA,IAAI,CAAC,EAAE,CAAC,OAAO,GAAG,CAAC;gBACjB,QAAQ,KAAK,CAAC,oBAAoB;YACpC;QAEF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,6BAA6B;YAC3C,IAAI,CAAC,gBAAgB;QACvB;IACF;IAEQ,mBAAmB;QACzB,IAAI,IAAI,CAAC,iBAAiB,GAAG,IAAI,CAAC,oBAAoB,EAAE;YACtD,IAAI,CAAC,iBAAiB;YACtB,QAAQ,GAAG,CAAC,CAAC,yBAAyB,EAAE,IAAI,CAAC,iBAAiB,CAAC,CAAC,EAAE,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC;YACjG,WAAW,IAAM,IAAI,CAAC,OAAO,IAAI,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC,iBAAiB;QAC/E,OAAO;YACL,QAAQ,KAAK,CAAC;QAChB;IACF;IAEO,QAAQ,QAAsC,EAAE;QACrD,IAAI,CAAC,aAAa,GAAG;QACrB,IAAI,IAAI,CAAC,WAAW,EAAE;YACpB,SAAS,IAAI,CAAC,WAAW;QAC3B;IACF;IAEO,iBAAqC;QAC1C,OAAO,IAAI,CAAC,WAAW;IACzB;IAEO,aAAa;QAClB,IAAI,IAAI,CAAC,EAAE,EAAE;YACX,IAAI,CAAC,EAAE,CAAC,KAAK;YACb,IAAI,CAAC,EAAE,GAAG;QACZ;IACF;AACF;AAEO,MAAM,kBAAkB,IAAI"}},
    {"offset": {"line": 155, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}},
    {"offset": {"line": 161, "column": 0}, "map": {"version":3,"sources":["file:///Users/mg/event-horizon/app/page.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState, useEffect } from 'react';\nimport { BskyAgent } from '@atproto/api';\nimport { BrowserOAuthClient } from '@atproto/oauth-client-browser';\nimport { firehoseService, CommitEvent } from '../services/firehose';\n\n// Initialize the OAuth client for development using loopback configuration\nconst oauthClient = new BrowserOAuthClient({\n  handleResolver: 'https://bsky.social',\n  // For development, we use undefined clientMetadata to enable loopback mode\n  clientMetadata: undefined,\n});\n\n// Initialize the Bluesky agent\nconst agent = new BskyAgent({ service: 'https://bsky.social' });\n\nexport default function Home() {\n  const [isLoading, setIsLoading] = useState(false);\n  const [isAuthenticated, setIsAuthenticated] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [userDid, setUserDid] = useState<string | null>(null);\n  const [handle, setHandle] = useState<string>('');\n  const [latestEvent, setLatestEvent] = useState<CommitEvent | null>(null);\n\n  // Initialize OAuth client and check for existing session\n  useEffect(() => {\n    const initOAuth = async () => {\n      try {\n        // Ensure we're using the loopback IP instead of localhost\n        if (window.location.hostname === 'localhost') {\n          window.location.replace(window.location.href.replace('localhost', '127.0.0.1'));\n          return;\n        }\n\n        const result = await oauthClient.init();\n        if (result?.session) {\n          setIsAuthenticated(true);\n          setUserDid(result.session.sub);\n          console.log('Session initialized for:', result.session.sub);\n        }\n      } catch (error) {\n        console.error('OAuth initialization error:', error);\n        setError(error instanceof Error ? error.message : 'Failed to initialize OAuth');\n      }\n    };\n\n    initOAuth();\n  }, []);\n\n  // Initialize Firehose and listen for events\n  useEffect(() => {\n    console.log(\"Setting up Firehose listener...\");\n    firehoseService.onEvent((event) => {\n      console.log(\"New event received:\", event);\n      setLatestEvent(event);\n    });\n  }, []);\n\n  const handleLogin = async () => {\n    if (!handle) {\n      setError('Please enter your Bluesky handle');\n      return;\n    }\n    \n    setIsLoading(true);\n    setError(null);\n    try {\n      await oauthClient.signIn(handle, {\n        state: Math.random().toString(36).substring(7),\n      });\n      // Note: This won't execute as signIn redirects the page\n    } catch (error) {\n      console.error('Login failed:', error);\n      setError(error instanceof Error ? error.message : 'Login failed');\n      setIsLoading(false);\n    }\n  };\n\n  const handleLogout = async () => {\n    try {\n      // Clear all browser storage\n      await window.indexedDB.deleteDatabase('atproto-oauth');\n      localStorage.clear();\n      sessionStorage.clear();\n\n      // Clear cookies\n      document.cookie.split(';').forEach(cookie => {\n        const [name] = cookie.split('=');\n        document.cookie = `${name.trim()}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;\n      });\n\n      // Reset state\n      setIsAuthenticated(false);\n      setUserDid(null);\n      setHandle('');\n\n      // Force reload to clear any in-memory state\n      window.location.href = window.location.origin;\n    } catch (error) {\n      console.error('Logout failed:', error);\n      setError(error instanceof Error ? error.message : 'Failed to logout');\n    }\n  };\n\n  return (\n    <main className=\"flex min-h-screen flex-col items-center justify-between p-24\">\n      <div className=\"z-10 max-w-5xl w-full items-center justify-between font-mono text-sm lg:flex\">\n        <div className=\"fixed bottom-0 left-0 flex h-48 w-full items-end justify-center bg-gradient-to-t from-white via-white dark:from-black dark:via-black lg:static lg:h-auto lg:w-auto lg:bg-none\">\n          {!isAuthenticated ? (\n            <div className=\"flex flex-col items-center space-y-4\">\n              <input\n                type=\"text\"\n                placeholder=\"Your handle (e.g. you.bsky.social)\"\n                value={handle}\n                onChange={(e) => setHandle(e.target.value)}\n                className=\"w-64 px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              />\n              {error && <p className=\"text-red-500 text-sm\">{error}</p>}\n              <button\n                onClick={handleLogin}\n                disabled={isLoading || !handle}\n                className=\"bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed\"\n              >\n                {isLoading ? 'Connecting...' : 'Login with Bluesky'}\n              </button>\n            </div>\n          ) : (\n            <div className=\"flex flex-col items-center space-y-4\">\n              <p>Logged in as: {userDid}</p>\n              <button\n                onClick={handleLogout}\n                className=\"bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded\"\n              >\n                Logout\n              </button>\n            </div>\n          )}\n        </div>\n      </div>\n\n      <div className=\"flex-1 w-full flex items-center justify-center\">\n        {latestEvent ? (\n          <div className=\"bg-white p-6 rounded-lg shadow-md max-w-2xl w-full\">\n            <h2 className=\"text-xl font-semibold mb-4\">Latest Firehose Event</h2>\n            <div className=\"space-y-2\">\n              <p><span className=\"font-semibold\">Sequence:</span> {latestEvent.seq}</p>\n              <p><span className=\"font-semibold\">Time:</span> {new Date(latestEvent.time).toLocaleString()}</p>\n              <p><span className=\"font-semibold\">Repository:</span> {latestEvent.repo}</p>\n              <div>\n                <p className=\"font-semibold mb-2\">Operations:</p>\n                <ul className=\"list-disc pl-5 space-y-1\">\n                  {latestEvent.ops.map((op, index) => (\n                    <li key={index} className=\"text-sm\">\n                      {op.action} - {op.path}\n                      {op.cid && <span className=\"text-gray-500 ml-2\">({op.cid.slice(0, 8)}...)</span>}\n                    </li>\n                  ))}\n                </ul>\n              </div>\n            </div>\n          </div>\n        ) : (\n          <p className=\"text-gray-600\">Waiting for Firehose events...</p>\n        )}\n      </div>\n    </main>\n  );\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 492, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}}]
}